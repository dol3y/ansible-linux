---
# PPA Docker Install
- block:
  - name: docker | add key
    apt_key:
      url: https://download.docker.com/linux/ubuntu/gpg
      id: 9DC858229FC7DD38854AE2D88D81803C0EBFCD88
      state: present

  - name: docker | install docker repo
    apt_repository:
      filename: docker
      repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
      update_cache: yes
      state: present

  - name: docker | install docker
    package:
      name: docker-ce
      state: present

  become: yes
  tags: docker
  when:
    - ansible_virtualization_role == "host"
    - ansible_virtualization_role != "NA"

# Distro Docker Install
- block:
  - name: docker | install docker
    package:
      name: docker.io
      state: present

  become: yes
  tags: docker
  when:
    - ansible_virtualization_role == "guest"
    - ansible_virtualization_role == "NA"

# Common Docker setup
- block:
  - name: docker | add docker group
    group:
      name: docker
      state: present

  - name: docker | update group
    user:
      name: "{{ lookup('env','USER') }}"
      append: yes
      groups: docker

  - name: docker | override.conf dir
    file:
      name: "{{ item }}"
      state: directory
      recurse: yes
    with_items:
      - /etc/systemd/system/docker.service.d
    when:
      - ansible_virtualization_role == "guest"

  - name: docker | write override.conf
    copy:
      src: "{{ item }}"
      dest: "/{{ item }}"
      backup: yes
    with_items:
      - etc/systemd/system/docker.service.d/override.conf
    when:
      - ansible_virtualization_role == "guest"
    notify: restart docker

  - name: docker | start
    service:
      name: docker
      state: started
      enabled: yes
    when:
      - ansible_virtualization_role == "guest"

  - name: docker | install docker-compose
    package:
      name: docker-compose
      state: present

  become: yes
  tags: docker
